- name: Activate virtual environment and run Flask app
  shell: |
    source {{ app_dir }}/.myenv/bin/activate
    FLASK_APP={{ app_dir }}/app.py FLASK_ENV=development flask run --host=0.0.0.0 --port=5000
  args:
    chdir: "{{ app_dir }}"
  async: 3600
  poll: 0
  register: flask_run_output

- name: Wait for Flask app to start
  async_status:
    jid: "{{ flask_run_output.ansible_job_id }}"
  register: job_result
  until: job_result.finished
  retries: 30
  delay: 10

